name: CI
on:
  #event : 워크플로우를 실행시키는 조건
  push:
    branches: [master]

  workflow_dispatch:

# job : 하나의 인스턴스(리눅스, 맥, 윈도우)에서 여러 step을 그룹시켜 실행하는 역할
jobs:
  build:
    # 환경
    runs-on: ubuntu-latest

    # step: 순차적으로 명령어를 수행
    # user : 다른 사람이 정의한 명령어 실행
    # run : 실행할 수 있는 스크립트
    steps:
      # 레파지토리 check out
      - name: Checkout source code.
        uses: actions/checkout@v2

      # node modules 캐싱 -> node_modules 저장하고 불러와 시간 감소
      - name: Cache node modules
        uses: actions/cache@v1
        with:
          path: node_modules
          key: ${{ runner.OS }}-build-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.OS }}-build-
            ${{ runner.OS }}-

      # node.js 버전 .12
      - uses: actions/setup-node@v2
        with:
          node-version: '12'

      # 의존 파일 설치
      - name: Install Dependencies
        run: npm install

      # 빌드
      - name: Build
        run: npm run build

      - name: Change folder name to docs
        run: mv build docs

      # # gitignore 삭제
      - name: Remove .gitignore
        run: rm .gitignore

      # release 브랜치 이동
      - name: Push to built branch
        uses: Automattic/action-commit-to-branch@master
        with:
          branch: 'release'
          commit_message: 'Build done!'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # deploy
      # - name: Deploy
      #   uses: peaceiris/actions-gh-pages@v2.5.0
      #   env:
      #     PERSONAL_TOKEN: ${{secrets.GH_PAT}}
      #     PUBLISH_BRANCH: release
      #     PUBLISH_DIR: ./public
      #     SCRIPT_MODE: true
